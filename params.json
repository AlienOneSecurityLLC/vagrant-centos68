{
  "name": "Vagrant-kafka",
  "tagline": "Setup 3 Node Kafka & Zookeeper VM Cluster - CentOS 6.8",
  "body": "###Vagrant Kafka/Zookeeper \r\n=============\r\n####Vagrant Configuration\r\n    + Provisions **six** CentOS 6.8 VMs\r\n    + Three node Apache Zookeeper Quorum (Replicated ZooKeeper)\r\n    + Three Apache Kafka Brokers \r\n    + JDK 8u112\r\n    + Kafka 0.10.1.0 \r\n    + Scala 2.10 \r\n    + Zookeeper 3.4.9 \r\n\r\n#####Prerequisites - Install the following prerequisites \r\n-------------------------\r\n+ [Vagrant](https://www.vagrantup.com/downloads.html)\r\n+ [VirtualBox](https://www.virtualbox.org/wiki/Downloads)\r\n\r\n####Setup\r\n-------------------------\r\n```\r\ngit clone git@github.com:AlienOneSecurityLLC/vagrant-kafka.git\r\ncd vagrant-kafka \r\nvagrant up\r\n```\r\n\r\n####Node Setup\r\n-------------------------\r\n+ $KAFKA_HOME_DIR ```$HOME/kafka_2.11-0.10.1.0/```\r\n+ $ZOOKEEPER_HOME_DIR ```embedded version of Zookeeper bundled with Kafka utilized```\r\n\r\n####VM Mappings & IP Addresses:\r\n--------------------------\r\n\r\n| Name        | Address    |\r\n|-------------|------------|\r\n|zookeeper1   | 10.30.3.2  |\r\n|zookeeper2   | 10.30.3.3  |\r\n|zookeeper3   | 10.30.3.4  |\r\n|broker1      | 10.30.3.30 |\r\n|broker2      | 10.30.3.20 |\r\n|broker3      | 10.30.3.10 |\r\n\r\n\r\n####Unit Status Test \r\n-------------------------\r\n\r\n+ Test all VM nodes are in state RUNNING \r\n\r\n```\r\nvagrant status\r\n```\r\n\r\n```\r\nCurrent machine states:\r\n\r\nzookeeper1                running (virtualbox)\r\nzookeeper2                running (virtualbox)\r\nzookeeper3                running (virtualbox)\r\nbroker1                   running (virtualbox)\r\nbroker2                   running (virtualbox)\r\nbroker3                   running (virtualbox)\r\n\r\n\r\nThis environment represents multiple VMs. The VMs are all listed\r\nabove with their current state. For more information about a specific\r\nVM, run 'vagrant status NAME''.\r\n```\r\n\r\n####Unit Accesses Test \r\n----------------------\r\n\r\n+ Login to any host with e.g., ```vagrant ssh broker1```. Some scripts have been included for convenience:\r\n\r\n+ Create a new topic ```/vagrant/scripts/create_topic.sh <topic name>``` (create as many as you see fit)\r\n\r\n+ Topic details can be listed with ```/vagrant/scripts/list-topics.sh```\r\n\r\n+ Start a console producer ```/vagrant/scripts/producer.sh <opic name>```. Type few messages and seperate them with new lines (Ctl-C to exit). \r\n\r\n+ ```/vagrant/scripts/consumer.sh <topic name>```: this will create a console consumer, getting messages from the topic created before. It will read all the messages each time starting from the beginning.\r\n\r\n+ Now anything you type in producer, it will show on the consumer. \r\n\r\n####Startup of all VMs\r\n------\r\n\r\n```for i in zookeeper{1..3} broker{1..3};do vagrant up $i;done```\r\n\r\n####Graceful Stop of All VMs \r\n------\r\n\r\n```for i in zookeeper{1..3} broker{1..3};do vagrant halt $i;done;```\r\n\r\n####Teardown & Rebase Development & Test Environment \r\n------\r\n\r\n+ To destroy/delete all the VMs\r\n\r\n```for i in zookeeper{1..3} broker{1..3};do vagrant destroy $i;done;```\r\n\r\n\r\n####Insights\r\n-------------\r\n\r\n#####Zookeeper (ZK)\r\n\r\n+ Kafka is using ZK for its operation. Here are some commands you can run on any of the nodes to see some of the internal Zookeeper structures created by Kafka. \r\n\r\n+ Open a ZK shell:\r\n\r\n```$HOME/kafka_2.11-0.10.1.0/bin/zookeeper-shell.sh 10.30.3.2:2181/```\r\n\r\n+ Inspect ZK structure: \r\n\r\n```\r\nls /\r\n[controller, controller_epoch, brokers, zookeeper, admin, isr_change_notification, consumers, config]\r\n```\r\n\r\n+ Get ZK version:\r\n    + First we need to install **nc** ```sudo yum install nc -y```\r\n    + To get the version of ZK type:\r\n    \r\n     ```\r\n     echo status | nc 10.30.3.2 2181\r\n     ```\r\n\r\n    + You can replace 10.30.3.2 with any ZK IP and execute the above command from any node within the cluster. \r\n\r\n\r\n#####Kafka\r\n\r\n+ Here we will see some more ways we can ingest data into Kafa. \r\n\r\n+ Pipe data directly into Kafka\r\n\r\n+ Login to any of the 6 nodes\r\n\r\n```\r\nvagrant ssh zookeeper1\r\n```\r\n\r\n+ Create a topic if does not exist\r\n\r\n```\r\n /vagrant/scripts/create_topic.sh test-one\r\n```\r\n\r\n+ Send data to the Kafka topic\r\n\r\n```\r\necho \"Yet another line from stdin\" | ./kafka_2.11-0.10.1.0/bin/kafka-console-producer.sh --topic test-one --broker-list 10.30.3.10:9092,10.30.3.20:9092,10.30.3.30:9092\r\n```\r\n\r\n+ You can then test that the line was added by running the consumer\r\n\r\n```\r\n/vagrant/scripts/consumer.sh test-one\r\n```\r\n\r\n+ Add a continues stream of data into Kafka\r\n\r\n+ Running **vmstat** will periodically export stats about the VM you are attached to. \r\n\r\n```\r\n>vmstat -a 1\r\n\r\nprocs -----------memory---------- ---swap-- -----io---- --system-- -----cpu-----\r\n r  b   swpd   free  inact active   si   so    bi    bo   in   cs us sy id wa st\r\n 0  0    960 113312 207368 130500    0    0    82   197  130  176  0  1 99  0  0\r\n 0  0    960 113312 207368 130500    0    0     0     0   60   76  0  0 100  0  0\r\n 0  0    960 113304 207368 130540    0    0     0     0   58   81  0  0 100  0  0\r\n 0  0    960 113304 207368 130540    0    0     0     0   53   76  0  1 99  0  0\r\n 0  0    960 113304 207368 130540    0    0     0     0   53   78  0  0 100  0  0\r\n 0  0    960 113304 207368 130540    0    0     0    16   64   90  0  0 100  0  0\r\n```\r\n\r\n+ We can redirect this output into Kafka\r\n\r\n```\r\nvmstat -a 1 | ./kafka_2.11-0.10.1.0/bin/kafka-console-producer.sh --topic test-one --broker-list 10.30.3.10:9092,10.30.3.20:9092,10.30.3.30:9092 &\r\n```\r\n\r\n+ While the producer runs in the background you can start the consumer to see what happens\r\n\r\n```\r\n/vagrant/scripts/consumer.sh test-one\r\n```\r\n\r\n+ You should be seeing the output of **vmstat** in the console. \r\n\r\n+ When you are all done, kill the consumer by **ctl-C** and then type **fg** to bring the producer in foreground and **crl-C** to terminate it. \r\n\r\n\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}